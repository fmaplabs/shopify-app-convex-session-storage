# Plan: Extract Shopify Session Storage into a Self-Contained Convex Component Package

## Context

The Shopify session storage integration currently spans three locations:

1. **Component** (`packages/backend/convex/components/shopify-app-convex-session-storage/`) — isolated Convex component with schema + CRUD functions
2. **Facade** (`packages/backend/convex/sessions/`) — `model.ts` wraps component calls, `queries.ts`/`mutations.ts` expose them as app-level functions
3. **Cargo adapter** (`apps/cargo/src/integrations/convex/session-storage.ts`) — implements Shopify's `SessionStorage` interface using `fetchQuery`/`fetchMutation`

**Problems with the current architecture:**
- No proper client class — consumers reach through `components.shopifyAppSessionStorage` directly or via an ad-hoc facade
- Some consumers bypass the facade entirely (e.g., `customers/mutations.ts:54` calls the component API directly)
- The `ShopifySession` type is manually defined in `model.ts` rather than exported from the component
- Missing return validators on several component functions (`findSessionsByShop`, `deleteSession`, `deleteSessions`, `storeSession`)
- Bug in `updateScopes` — passes table name as first arg to `ctx.db.patch`
- No clear boundary between component internals and public API

**Goal:** Extract into `packages/shopify-session-storage/` as a self-contained Convex component following the [authoring docs](https://docs.convex.dev/components/authoring) with a class-based client.

**Reference:** https://docs.convex.dev/components/authoring

---

## Step 1: Create package scaffolding

Create `packages/shopify-session-storage/` with this structure:

```
packages/shopify-session-storage/
├── package.json
├── tsconfig.json
├── convex.config.ts          # defineComponent("shopifySessionStorage")
├── schema.ts                 # sessions table + validator exports
├── sessions.ts               # Component functions (all with return validators)
├── _generated/               # Auto-generated by convex codegen
└── src/
    ├── index.ts              # ShopifySessionClient class + type exports
    └── types.ts              # ShopifySession type, ComponentApi re-export
```

**`package.json`** — workspace package with exports:
```json
{
  "name": "@airfare/shopify-session-storage",
  "version": "0.0.1",
  "exports": {
    ".": "./src/index.ts",
    "./convex.config": "./convex.config.ts"
  },
  "dependencies": {
    "convex": "^1.31.7"
  }
}
```

Note: `pnpm-workspace.yaml` already includes `packages/*` so this will be auto-detected.

**Files to move:**
- `components/shopify-app-convex-session-storage/convex.config.ts` → `packages/shopify-session-storage/convex.config.ts`
- `components/shopify-app-convex-session-storage/schema.ts` → `packages/shopify-session-storage/schema.ts`
- `components/shopify-app-convex-session-storage/sessions.ts` → `packages/shopify-session-storage/sessions.ts`

---

## Step 2: Clean up component functions (`sessions.ts`)

While moving, fix these issues:

- **Add return validators** to `findSessionsByShop`, `deleteSession`, `deleteSessions`, `storeSession`
- **Fix `updateScopes` bug** (line 206): `ctx.db.patch("sessions", existing._id, ...)` → `ctx.db.patch(existing._id, ...)`
- **Import from `_generated/server`** (the component's own generated server, not the app's)

---

## Step 3: Create client class (`src/index.ts`)

Following the [class-based client pattern](https://docs.convex.dev/components/authoring#class-based-client) from the docs:

```typescript
import { type ComponentApi } from "../_generated/component";
import type { GenericQueryCtx, GenericMutationCtx, GenericActionCtx, GenericDataModel } from "convex/server";

type Ctx = GenericQueryCtx<GenericDataModel> | GenericActionCtx<GenericDataModel>;
type MutCtx = GenericMutationCtx<GenericDataModel> | GenericActionCtx<GenericDataModel>;

export class ShopifySessionClient {
  constructor(public component: ComponentApi) {}

  async loadSession(ctx: Ctx, { id }: { id: string }): Promise<ShopifySession | null> {
    return await ctx.runQuery(this.component.sessions.loadSession, { id });
  }

  async storeSession(ctx: MutCtx, session: ShopifySessionInput) {
    return await ctx.runMutation(this.component.sessions.storeSession, session);
  }

  async deleteSession(ctx: MutCtx, { id }: { id: string }) {
    return await ctx.runMutation(this.component.sessions.deleteSession, { id });
  }

  async deleteSessions(ctx: MutCtx, { ids }: { ids: string[] }) {
    return await ctx.runMutation(this.component.sessions.deleteSessions, { ids });
  }

  async findSessionsByShop(ctx: Ctx, { shop }: { shop: string }) {
    return await ctx.runQuery(this.component.sessions.findSessionsByShop, { shop });
  }

  async getOfflineSessionByShop(ctx: Ctx, { shop }: { shop: string }): Promise<ShopifySession | null> {
    return await ctx.runQuery(this.component.sessions.getOfflineSessionByShop, { shop });
  }

  async deleteSessionsByShop(ctx: MutCtx, { shop }: { shop: string }) {
    return await ctx.runMutation(this.component.sessions.deleteSessionsByShop, { shop });
  }

  async cleanupExpiredSessions(ctx: MutCtx, { currentTimeISO }: { currentTimeISO: string }) {
    return await ctx.runMutation(this.component.sessions.cleanupExpiredSessions, { currentTimeISO });
  }
}
```

Export `ShopifySession` type and `ComponentApi` re-export from `src/types.ts`.

---

## Step 4: Update backend package (`packages/backend/`)

### 4a. Update `convex.config.ts`
```diff
- import shopifyAppSessionStorage from './components/shopify-app-convex-session-storage/convex.config'
+ import shopifyAppSessionStorage from '@airfare/shopify-session-storage/convex.config'
```

### 4b. Instantiate client in `sessions/model.ts`
Replace the entire file with a client instantiation + re-exports:
```typescript
import { ShopifySessionClient } from '@airfare/shopify-session-storage';
import { components } from '../_generated/api';

export const sessionClient = new ShopifySessionClient(components.shopifyAppSessionStorage);

// Delegate functions for backward compatibility
export const loadSession = sessionClient.loadSession.bind(sessionClient);
export const storeSession = sessionClient.storeSession.bind(sessionClient);
export const deleteSession = sessionClient.deleteSession.bind(sessionClient);
export const deleteSessions = sessionClient.deleteSessions.bind(sessionClient);
export const findSessionsByShop = sessionClient.findSessionsByShop.bind(sessionClient);
export const getOfflineSessionByShop = sessionClient.getOfflineSessionByShop.bind(sessionClient);
export const deleteSessionsByShop = sessionClient.deleteSessionsByShop.bind(sessionClient);
export const cleanupExpiredSessions = sessionClient.cleanupExpiredSessions.bind(sessionClient);

// Re-export the type
export type { ShopifySession } from '@airfare/shopify-session-storage';
```

### 4c. Update `sessions/queries.ts` and `sessions/mutations.ts`
These stay thin — they already import from `./model` and delegate. No changes needed since `model.ts` still exports the same function signatures.

### 4d. Update `access/admin.ts`
- Change `components.shopifyAppSessionStorage.sessions.loadSession` → use `sessionClient.loadSession(ctx, { id })` or keep importing `loadSession` from `sessions/model`
- Import `sessionClient` or `loadSession` from `sessions/model`

### 4e. Update `access/customer.ts`
Already uses `getOfflineSessionByShop` from `sessions/model` — no change needed once model re-exports from client.

### 4f. Update `customers/mutations.ts`
- Line 54: Replace direct `components.shopifyAppSessionStorage.sessions.getOfflineSessionByShop` with `sessionClient.getOfflineSessionByShop(ctx, { shop })` (import from `sessions/model`)

### 4g. Delete old component directory
Remove `packages/backend/convex/components/shopify-app-convex-session-storage/` entirely.

### 4h. Add dependency
In `packages/backend/package.json`:
```json
"@airfare/shopify-session-storage": "workspace:*"
```

---

## Step 5: Update cargo app

The `ConvexSessionStorage` class in `apps/cargo/src/integrations/convex/session-storage.ts` uses `fetchQuery`/`fetchMutation` to call **app-level** functions (`api.sessions.queries.*`, `api.sessions.mutations.*`). Since those app-level wrappers in `sessions/queries.ts` and `sessions/mutations.ts` still exist (they just delegate through the client now), **no changes needed** in the cargo adapter.

---

## Key Architecture Notes

### Why two layers?
The cargo app's `ConvexSessionStorage` adapter uses `fetchQuery`/`fetchMutation` (HTTP-level calls from outside Convex). Component functions are *internal* — only callable via `ctx.runQuery`/`ctx.runMutation` from within the Convex runtime. This means the app-level wrapper functions in `sessions/queries.ts` and `sessions/mutations.ts` must remain as the HTTP-accessible bridge.

### Component constraints (from Convex docs)
- `process.env` is **not available** inside components — pass config as function args
- `ctx.auth` is **not available** inside components — pass user identifiers explicitly
- Component `Id<"table">` types become `string` outside the component
- HTTP actions cannot be defined in components

---

## Files Modified (Summary)

| Action | File |
|--------|------|
| **Create** | `packages/shopify-session-storage/package.json` |
| **Create** | `packages/shopify-session-storage/tsconfig.json` |
| **Move** | `packages/shopify-session-storage/convex.config.ts` |
| **Move+Fix** | `packages/shopify-session-storage/schema.ts` |
| **Move+Fix** | `packages/shopify-session-storage/sessions.ts` |
| **Create** | `packages/shopify-session-storage/src/index.ts` |
| **Create** | `packages/shopify-session-storage/src/types.ts` |
| **Edit** | `packages/backend/convex/convex.config.ts` |
| **Rewrite** | `packages/backend/convex/sessions/model.ts` |
| **No change** | `packages/backend/convex/sessions/queries.ts` |
| **No change** | `packages/backend/convex/sessions/mutations.ts` |
| **Edit** | `packages/backend/convex/access/admin.ts` |
| **Edit** | `packages/backend/convex/customers/mutations.ts` |
| **Edit** | `packages/backend/package.json` |
| **Delete** | `packages/backend/convex/components/shopify-app-convex-session-storage/` (entire dir) |

**No changes needed:**
- `apps/cargo/src/integrations/convex/session-storage.ts` (still calls app-level API)
- All sync files (`bundles/sync.ts`, `products/sync.ts`, etc.) — they import from `sessions/model` which re-exports
- `access/customer.ts` — imports from `sessions/model` which re-exports

---

## Consumers Reference

These files import from `sessions/model` (all use `getOfflineSessionByShop`):
- `packages/backend/convex/orders/sync.ts`
- `packages/backend/convex/contracts/sync.ts`
- `packages/backend/convex/products/sync.ts`
- `packages/backend/convex/bundles/sync.ts`
- `packages/backend/convex/customers/sync.ts`
- `packages/backend/convex/workflows/updateOrderWorkflow.ts`
- `packages/backend/convex/workflows/billingChargesWorkflow.ts`
- `packages/backend/convex/workflows/updateContractWorkflow.ts`
- `packages/backend/convex/paymentMethods/sync.ts`
- `packages/backend/convex/sellingPlans/sync.ts`
- `packages/backend/convex/dunning/webhookHandlers.ts`
- `packages/backend/convex/dunning/billing.ts`
- `packages/backend/convex/access/admin.ts` (uses `ShopifySession` type)
- `packages/backend/convex/access/customer.ts` (uses `getOfflineSessionByShop`)

Direct component API callers (need updating):
- `packages/backend/convex/access/admin.ts:22` — `components.shopifyAppSessionStorage.sessions.loadSession`
- `packages/backend/convex/customers/mutations.ts:54` — `components.shopifyAppSessionStorage.sessions.getOfflineSessionByShop`

---

## Verification

1. **`pnpm install`** — ensure workspace link resolves `@airfare/shopify-session-storage`
2. **`npx convex dev`** (in backend package) — should generate `_generated/` for both the app and the new component package, and type-check the component
3. **TypeScript** — `pnpm run check-types` in backend package should pass (ignoring pre-existing errors)
4. **End-to-end** — Start the cargo app, verify:
   - OAuth flow stores/loads sessions correctly (install the app on a dev store)
   - Background sync functions can retrieve offline sessions
   - Admin session token validation works in the embedded app
